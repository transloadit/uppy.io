"use strict";(self.webpackChunkuppy_io=self.webpackChunkuppy_io||[]).push([[119],{811:(e,n,o)=>{o.r(n),o.d(n,{assets:()=>a,contentTitle:()=>r,default:()=>h,frontMatter:()=>t,metadata:()=>d,toc:()=>l});var i=o(74848),s=o(28453);const t={sidebar_position:4},r="Companion",d={id:"companion",title:"Companion",description:"Companion is an open source server application which takes away the complexity",source:"@site/docs/companion.md",sourceDirName:".",slug:"/companion",permalink:"/docs/companion",draft:!1,unlisted:!1,editUrl:"https://github.com/transloadit/uppy/blob/main/docs/companion.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{sidebar_position:4},sidebar:"tutorialSidebar",previous:{title:"Uppy core",permalink:"/docs/uppy"},next:{title:"Dashboard",permalink:"/docs/dashboard"}},a={},l=[{value:"When should I use it?",id:"when-should-i-use-it",level:2},{value:"Hosted",id:"hosted",level:2},{value:"Installation &amp; use",id:"installation--use",level:2},{value:"Standalone mode",id:"standalone-mode",level:3},{value:"Express middleware mode",id:"express-middleware-mode",level:3},{value:"Running many instances",id:"running-many-instances",level:3},{value:"Using unique endpoints",id:"using-unique-endpoints",level:4},{value:"Using a load balancer",id:"using-a-load-balancer",level:4},{value:"API",id:"api",level:2},{value:"Options",id:"options",level:3},{value:"<code>filePath</code> <code>COMPANION_DATADIR</code>",id:"filepath-companion_datadir",level:4},{value:"<code>secret</code> <code>COMPANION_SECRET</code> <code>COMPANION_SECRET_FILE</code>",id:"secret-companion_secret-companion_secret_file",level:4},{value:"<code>preAuthSecret</code> <code>COMPANION_PREAUTH_SECRET</code> <code>COMPANION_PREAUTH_SECRET_FILE</code>",id:"preauthsecret-companion_preauth_secret-companion_preauth_secret_file",level:4},{value:"<code>uploadUrls</code> <code>COMPANION_UPLOAD_URLS</code>",id:"uploadurls-companion_upload_urls",level:4},{value:"<code>COMPANION_PORT</code>",id:"companion_port",level:4},{value:"<code>COMPANION_COOKIE_DOMAIN</code>",id:"companion_cookie_domain",level:4},{value:"<code>COMPANION_HIDE_WELCOME</code>",id:"companion_hide_welcome",level:4},{value:"<code>redisUrl</code> <code>COMPANION_REDIS_URL</code>",id:"redisurl-companion_redis_url",level:4},{value:"<code>COMPANION_REDIS_EXPRESS_SESSION_PREFIX</code>",id:"companion_redis_express_session_prefix",level:4},{value:"<code>redisOptions</code> <code>COMPANION_REDIS_OPTIONS</code>",id:"redisoptions-companion_redis_options",level:4},{value:"<code>redisPubSubScope</code> <code>COMPANION_REDIS_PUBSUB_SCOPE</code>",id:"redispubsubscope-companion_redis_pubsub_scope",level:4},{value:"<code>server</code>",id:"server",level:4},{value:"<code>sendSelfEndpoint</code> <code>COMPANION_SELF_ENDPOINT</code>",id:"sendselfendpoint-companion_self_endpoint",level:4},{value:"<code>providerOptions</code>",id:"provideroptions",level:4},{value:"<code>s3</code>",id:"s3",level:4},{value:"<code>s3.key</code> <code>COMPANION_AWS_KEY</code>",id:"s3key-companion_aws_key",level:5},{value:"<code>s3.secret</code> <code>COMPANION_AWS_SECRET</code> <code>COMPANION_AWS_SECRET_FILE</code>",id:"s3secret-companion_aws_secret-companion_aws_secret_file",level:5},{value:"<code>s3.endpoint</code> <code>COMPANION_AWS_ENDPOINT</code>",id:"s3endpoint-companion_aws_endpoint",level:5},{value:"<code>s3.bucket</code> <code>COMPANION_AWS_BUCKET</code>",id:"s3bucket-companion_aws_bucket",level:5},{value:"<code>s3.forcePathStyle</code> <code>COMPANION_AWS_FORCE_PATH_STYLE</code>",id:"s3forcepathstyle-companion_aws_force_path_style",level:4},{value:"<code>s3.region</code> <code>COMPANION_AWS_REGION</code>",id:"s3region-companion_aws_region",level:5},{value:"<code>COMPANION_AWS_PREFIX</code>",id:"companion_aws_prefix",level:5},{value:"<code>s3.awsClientOptions</code>",id:"s3awsclientoptions",level:5},{value:"<code>s3.getKey({ filename, metadata, req })</code>",id:"s3getkey-filename-metadata-req-",level:5},{value:"<code>COMPANION_AWS_USE_ACCELERATE_ENDPOINT</code>",id:"companion_aws_use_accelerate_endpoint",level:4},{value:"<code>COMPANION_AWS_EXPIRES</code>",id:"companion_aws_expires",level:4},{value:"<code>COMPANION_AWS_ACL</code>",id:"companion_aws_acl",level:4},{value:"<code>customProviders</code>",id:"customproviders",level:4},{value:"<code>logClientVersion</code>",id:"logclientversion",level:4},{value:"<code>metrics</code> <code>COMPANION_HIDE_METRICS</code>",id:"metrics-companion_hide_metrics",level:4},{value:"<code>streamingUpload</code> <code>COMPANION_STREAMING_UPLOAD</code>",id:"streamingupload-companion_streaming_upload",level:4},{value:"<code>maxFileSize</code> <code>COMPANION_MAX_FILE_SIZE</code>",id:"maxfilesize-companion_max_file_size",level:4},{value:"<code>periodicPingUrls</code> <code>COMPANION_PERIODIC_PING_URLS</code>",id:"periodicpingurls-companion_periodic_ping_urls",level:4},{value:"<code>periodicPingInterval</code> <code>COMPANION_PERIODIC_PING_INTERVAL</code>",id:"periodicpinginterval-companion_periodic_ping_interval",level:4},{value:"<code>periodicPingStaticPayload</code> <code>COMPANION_PERIODIC_PING_STATIC_JSON_PAYLOAD</code>",id:"periodicpingstaticpayload-companion_periodic_ping_static_json_payload",level:4},{value:"<code>allowLocalUrls</code> <code>COMPANION_ALLOW_LOCAL_URLS</code>",id:"allowlocalurls-companion_allow_local_urls",level:4},{value:"<code>corsOrigins</code> (required)",id:"corsorigins-required",level:4},{value:"<code>COMPANION_CLIENT_ORIGINS</code>",id:"companion_client_origins",level:5},{value:"<code>COMPANION_CLIENT_ORIGINS_REGEX</code>",id:"companion_client_origins_regex",level:5},{value:"<code>chunkSize</code> <code>COMPANION_CHUNK_SIZE</code>",id:"chunksize-companion_chunk_size",level:4},{value:"<code>enableUrlEndpoint</code> <code>COMPANION_ENABLE_URL_ENDPOINT</code>",id:"enableurlendpoint-companion_enable_url_endpoint",level:4},{value:"<code>enableGooglePickerEndpoint</code> <code>COMPANION_ENABLE_GOOGLE_PICKER_ENDPOINT</code>",id:"enablegooglepickerendpoint-companion_enable_google_picker_endpoint",level:4},{value:"Events",id:"events",level:3},{value:"Frequently asked questions",id:"frequently-asked-questions",level:2},{value:"Do you have a live example?",id:"do-you-have-a-live-example",level:3},{value:"How does the Authentication and Token mechanism work?",id:"how-does-the-authentication-and-token-mechanism-work",level:3},{value:"How to use provider redirect URIs?",id:"how-to-use-provider-redirect-uris",level:3},{value:"How to use Companion with Kubernetes?",id:"how-to-use-companion-with-kubernetes",level:3},{value:"How to add custom providers?",id:"how-to-add-custom-providers",level:3},{value:"list data",id:"list-data",level:4},{value:"How to run Companion locally?",id:"how-to-run-companion-locally",level:3}];function c(e){const n={a:"a",admonition:"admonition",code:"code",details:"details",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",h5:"h5",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",summary:"summary",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h1,{id:"companion",children:"Companion"}),"\n",(0,i.jsxs)(n.p,{children:["Companion is an open source server application which ",(0,i.jsx)(n.strong,{children:"takes away the complexity\nof authentication and the cost of downloading files from remote sources"}),", such\nas Instagram, Google Drive, and others. Companion is a server-to-server\norchestrator that streams files from a source to a destination, and files are\nnever stored in Companion. Companion can run either as a standalone\n(self-hosted) application, ",(0,i.jsx)(n.a,{href:"#hosted",children:"Transloadit-hosted"}),", or plugged in as an\nExpress middleware into an existing application. The Uppy client requests remote\nfiles from Companion, which it will download and simultaneously upload to your\n",(0,i.jsx)(n.a,{href:"/docs/tus",children:"Tus server"}),", ",(0,i.jsx)(n.a,{href:"/docs/aws-s3",children:"AWS bucket"}),", or any server that supports\n",(0,i.jsx)(n.a,{href:"/docs/xhr-upload",children:"PUT, POST or Multipart uploads"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"This means a user uploading a 5GB video from Google Drive from their phone isn\u2019t\neating into their data plans and you don\u2019t have to worry about implementing\nOAuth."}),"\n",(0,i.jsx)(n.h2,{id:"when-should-i-use-it",children:"When should I use it?"}),"\n",(0,i.jsxs)(n.p,{children:["If you want to let users download files from ",(0,i.jsx)(n.a,{href:"/docs/box",children:"Box"}),", ",(0,i.jsx)(n.a,{href:"/docs/dropbox",children:"Dropbox"}),", ",(0,i.jsx)(n.a,{href:"/docs/facebook",children:"Facebook"}),",\n",(0,i.jsx)(n.a,{href:"/docs/google-drive",children:"Google Drive"}),", ",(0,i.jsx)(n.a,{href:"/docs/google-photos",children:"Google Photos"}),", ",(0,i.jsx)(n.a,{href:"/docs/google-drive-picker",children:"Google Drive\nPicker"}),", ",(0,i.jsx)(n.a,{href:"/docs/google-photos-picker",children:"Google Photos Picker"}),",\n",(0,i.jsx)(n.a,{href:"/docs/instagram",children:"Instagram"}),", ",(0,i.jsx)(n.a,{href:"/docs/onedrive",children:"OneDrive"}),", ",(0,i.jsx)(n.a,{href:"/docs/unsplash",children:"Unsplash"}),", ",(0,i.jsx)(n.a,{href:"/docs/url",children:"Import from URL"}),", or ",(0,i.jsx)(n.a,{href:"/docs/zoom",children:"Zoom"})," \u2014\nyou need Companion."]}),"\n",(0,i.jsxs)(n.p,{children:["Companion supports the same ",(0,i.jsx)(n.a,{href:"/docs/guides/choosing-uploader",children:"uploaders"})," as Uppy:\n",(0,i.jsx)(n.a,{href:"/docs/tus",children:"Tus"}),", ",(0,i.jsx)(n.a,{href:"/docs/aws-s3",children:"AWS S3"}),", and ",(0,i.jsx)(n.a,{href:"/docs/tus",children:"regular multipart"}),".\nBut instead of manually setting a plugin, Uppy sends along a header with the\nuploader and Companion will use the same on the server. This means if you are\nusing ",(0,i.jsx)(n.a,{href:"/docs/tus",children:"Tus"})," for your local uploads, you can send your remote uploads\nto the same Tus server (and likewise for your AWS S3 bucket)."]}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsxs)(n.p,{children:["Companion only deals with ",(0,i.jsx)(n.em,{children:"remote"})," files, ",(0,i.jsx)(n.em,{children:"local"})," files are still uploaded from\nthe client with your upload plugin."]})}),"\n",(0,i.jsx)(n.h2,{id:"hosted",children:"Hosted"}),"\n",(0,i.jsxs)(n.p,{children:["Using ",(0,i.jsx)(n.a,{href:"https://transloadit.com",children:"Transloadit"})," services comes with a hosted version of Companion so you\ndon\u2019t have to worry about hosting your own server. Whether you are on a free or\npaid Transloadit ",(0,i.jsx)(n.a,{href:"https://transloadit.com/pricing/",children:"plan"}),", you can use\nCompanion. It\u2019s not possible to rent a Companion server without a Transloadit\nplan."]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"https://transloadit.com/pricing/",children:(0,i.jsx)(n.strong,{children:"Sign-up for a (free) plan"})}),"."]}),"\n",(0,i.jsx)(n.admonition,{type:"tip",children:(0,i.jsx)(n.p,{children:"Choosing Transloadit for your file services also comes with credentials for all\nremote providers. This means you don\u2019t have to waste time going through the\napproval process of every app. You can still add your own credentials in the\nTransloadit admin page if you want."})}),"\n",(0,i.jsx)(n.admonition,{type:"info",children:(0,i.jsxs)(n.p,{children:["Downloading and uploading files through Companion doesn\u2019t count towards your\n",(0,i.jsx)(n.a,{href:"https://transloadit.com/docs/faq/1gb-worth/",children:"monthly quota"}),", it\u2019s a way for\nfiles to arrive at Transloadit servers, much like Uppy."]})}),"\n",(0,i.jsx)(n.p,{children:"To do so each provider plugin must be configured with Transloadit\u2019s Companion\nURLs:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:"import { COMPANION_URL, COMPANION_ALLOWED_HOSTS } from '@uppy/transloadit';\nimport Dropbox from '@uppy/dropbox';\n\nuppy.use(Dropbox, {\n\tcompanionUrl: COMPANION_URL,\n\tcompanionAllowedHosts: COMPANION_ALLOWED_HOSTS,\n});\n"})}),"\n",(0,i.jsx)(n.p,{children:"You may also hit rate limits, because the OAuth application is shared between\neveryone using Transloadit."}),"\n",(0,i.jsxs)(n.p,{children:["To solve that, you can use your own OAuth keys with Transloadit\u2019s hosted\nCompanion servers by using Transloadit Template Credentials. ",(0,i.jsx)(n.a,{href:"https://transloadit.com/docs/#how-to-create-template-credentials",children:"Create a Template\nCredential"})," on the Transloadit site. Select \u201cCompanion\nOAuth\u201d for the service, and enter the key and secret for the provider you want\nto use. Then you can pass the name of the new credentials to that provider:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:"import { COMPANION_URL, COMPANION_ALLOWED_HOSTS } from '@uppy/transloadit';\nimport Dropbox from '@uppy/dropbox';\n\nuppy.use(Dropbox, {\n\tcompanionUrl: COMPANION_URL,\n\tcompanionAllowedHosts: COMPANION_ALLOWED_HOSTS,\n\tcompanionKeysParams: {\n\t\tkey: 'YOUR_TRANSLOADIT_API_KEY',\n\t\tcredentialsName: 'my_companion_dropbox_creds',\n\t},\n});\n"})}),"\n",(0,i.jsx)(n.h2,{id:"installation--use",children:"Installation & use"}),"\n",(0,i.jsxs)(n.p,{children:["Companion is installed from npm. Depending on how you want to run Companion, the\ninstall process is slightly different. Companion can be integrated as middleware\ninto your ",(0,i.jsx)(n.a,{href:"https://expressjs.com/",children:"Express"})," app or as a standalone server. Most\npeople probably want to run it as a standalone server, while the middleware\ncould be used to further customise Companion or integrate it into your own HTTP\nserver code."]}),"\n",(0,i.jsxs)(n.admonition,{type:"note",children:[(0,i.jsxs)(n.p,{children:["Since v2, you need to be running ",(0,i.jsx)(n.code,{children:"node.js >= v10.20.1"})," to use Companion. More\ninformation in the\n",(0,i.jsx)(n.a,{href:"/docs/guides/migration-guides/#migrate-from-uppy-1x-to-2x",children:"migrating to 2.0"}),"\nguide."]}),(0,i.jsx)(n.p,{children:"Windows is not a supported platform right now. It may work, and we\u2019re happy to\naccept improvements in this area, but we can\u2019t provide support."})]}),"\n",(0,i.jsx)(n.h3,{id:"standalone-mode",children:"Standalone mode"}),"\n",(0,i.jsx)(n.p,{children:"You can use the standalone version if you want to run Companion as it\u2019s own\nNode.js process. It\u2019s a configured Express server with sessions, logging, and\nsecurity best practices. First you\u2019ll typically want to install it globally:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"npm install -g @uppy/companion\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Standalone Companion will always serve HTTP (not HTTPS) and expects a reverse\nproxy with SSL termination in front of it when running in production. See\n",(0,i.jsx)(n.a,{href:"#server",children:(0,i.jsx)(n.code,{children:"COMPANION_PROTOCOL"})})," for more information."]}),"\n",(0,i.jsxs)(n.p,{children:["Companion ships with an executable file (",(0,i.jsx)(n.code,{children:"bin/companion"}),") which is the\nstandalone server. Unlike the middleware version, options are set via\nenvironment variables."]}),"\n",(0,i.jsx)(n.admonition,{type:"info",children:(0,i.jsxs)(n.p,{children:["Checkout ",(0,i.jsx)(n.a,{href:"#options",children:"options"})," for the available options in JS and environment\nvariable formats."]})}),"\n",(0,i.jsx)(n.p,{children:"You need at least these three to get started:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'export COMPANION_SECRET="shh!Issa Secret!"\nexport COMPANION_DOMAIN="YOUR SERVER DOMAIN"\nexport COMPANION_DATADIR="PATH/TO/DOWNLOAD/DIRECTORY"\n'})}),"\n",(0,i.jsx)(n.p,{children:"Then run:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"companion\n"})}),"\n",(0,i.jsx)(n.p,{children:"You can also pass in the path to your JSON config file, like so:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"companion --config /path/to/companion.json\n"})}),"\n",(0,i.jsxs)(n.p,{children:["You may also want to run Companion in a process manager like\n",(0,i.jsx)(n.a,{href:"https://pm2.keymetrics.io/",children:"PM2"})," to make sure it gets restarted on upon\ncrashing as well as allowing scaling to many instances."]}),"\n",(0,i.jsx)(n.h3,{id:"express-middleware-mode",children:"Express middleware mode"}),"\n",(0,i.jsx)(n.p,{children:"First install it into your Node.js project with your favorite package manager:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"npm install @uppy/companion\n"})}),"\n",(0,i.jsxs)(n.p,{children:["To plug Companion into an existing server, call its ",(0,i.jsx)(n.code,{children:".app"})," method, passing in an\n",(0,i.jsx)(n.a,{href:"#options",children:"options"})," object as a parameter. This returns a server instance that\nyou can mount on a route in your Express app. Note: do ",(0,i.jsx)(n.strong,{children:"not"})," use the ",(0,i.jsx)(n.code,{children:"cors"}),"\nmodule in your project, because Companion already includes it. Use the\n",(0,i.jsx)(n.code,{children:"corsOrigins"})," Companion option to customise CORS behavior."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:"import express from 'express';\nimport bodyParser from 'body-parser';\nimport session from 'express-session';\nimport companion from '@uppy/companion';\n\nconst app = express();\n\n// Companion requires body-parser and express-session middleware.\n// You can add it like this if you use those throughout your app.\n//\n// If you are using something else in your app, you can add these\n// middlewares in the same subpath as Companion instead.\napp.use(bodyParser.json());\napp.use(session({ secret: 'some secrety secret' }));\n\nconst companionOptions = {\n\tproviderOptions: {\n\t\tdrive: {\n\t\t\tkey: 'GOOGLE_DRIVE_KEY',\n\t\t\tsecret: 'GOOGLE_DRIVE_SECRET',\n\t\t},\n\t},\n\tserver: {\n\t\thost: 'localhost:3020',\n\t\tprotocol: 'http',\n\t\t// Default installations normally don't need a path.\n\t\t// However if you specify a `path`, you MUST specify\n\t\t// the same path in `app.use()` below,\n\t\t// e.g. app.use('/companion', companionApp)\n\t\t// path: '/companion',\n\t},\n\tfilePath: '/path/to/folder/',\n};\n\nconst { app: companionApp } = companion.app(companionOptions);\napp.use(companionApp);\n"})}),"\n",(0,i.jsx)(n.p,{children:"Companion uses WebSockets to communicate progress, errors, and successes to the\nclient. This is what Uppy listens to to update it\u2019s internal state and UI."}),"\n",(0,i.jsxs)(n.p,{children:["Add the Companion WebSocket server using the ",(0,i.jsx)(n.code,{children:"companion.socket"})," function:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:"const server = app.listen(PORT);\n\ncompanion.socket(server);\n"})}),"\n",(0,i.jsx)(n.p,{children:"If WebSockets fail for some reason Uppy and Companion will fallback to HTTP\npolling."}),"\n",(0,i.jsx)(n.h3,{id:"running-many-instances",children:"Running many instances"}),"\n",(0,i.jsx)(n.p,{children:"We recommend running at least two instances in production, so that if the\nNode.js event loop gets blocked by one or more requests (due to a bug or spike\nin traffic), it doesn\u2019t also block or slow down all other requests as well (as\nNode.js is single threaded)."}),"\n",(0,i.jsxs)(n.p,{children:["As an example for scale, one enterprise customer of Transloadit, who self-hosts\nCompanion to power an education service that is used by many universities\nglobally, deploys 7 Companion instances. Their earlier solution ran on 35\ninstances. In our general experience Companion will saturate network interface\ncards before other resources on commodity virtual servers (",(0,i.jsx)(n.code,{children:"c5d.2xlarge"})," for\ninstance)."]}),"\n",(0,i.jsxs)(n.p,{children:["Your mileage may vary, so we recommend to add observability. You can let\nPrometheus crawl the ",(0,i.jsx)(n.code,{children:"/metrics"})," endpoint and graph that with Grafana for\ninstance."]}),"\n",(0,i.jsx)(n.h4,{id:"using-unique-endpoints",children:"Using unique endpoints"}),"\n",(0,i.jsx)(n.p,{children:"One option is to run many instances with each instance having its own unique\nendpoint. This could be on separate ports, (sub)domain names, or IPs. With this\nsetup, you can either:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Implement your own logic that will direct each upload to a specific Companion\nendpoint by setting the ",(0,i.jsx)(n.code,{children:"companionUrl"})," option"]}),"\n",(0,i.jsxs)(n.li,{children:["Setting the Companion option ",(0,i.jsx)(n.code,{children:"COMPANION_SELF_ENDPOINT"}),". This option will\ncause Companion to respond with a ",(0,i.jsx)(n.code,{children:"i-am"})," HTTP header containing the value\nfrom ",(0,i.jsx)(n.code,{children:"COMPANION_SELF_ENDPOINT"}),". When Uppy\u2019s sees this header, it will pin all\nrequests for the upload to this endpoint."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["In either case, you would then also typically configure a single Companion\ninstance (one endpoint) to handle all OAuth authentication requests, so that you\nonly need to specify a single OAuth callback URL. See also ",(0,i.jsx)(n.code,{children:"oauthDomain"})," and\n",(0,i.jsx)(n.code,{children:"validHosts"}),"."]}),"\n",(0,i.jsx)(n.h4,{id:"using-a-load-balancer",children:"Using a load balancer"}),"\n",(0,i.jsxs)(n.p,{children:["The other option is to set up a load balancer in front of many Companion\ninstances. Then Uppy will only see a single endpoint and send all requests to\nthe associated load balancer, which will then distribute them between Companion\ninstances. The companion instances coordinate their messages and events over\nRedis so that any instance can serve the client\u2019s requests. Note that sticky\nsessions are ",(0,i.jsx)(n.strong,{children:"not"})," needed with this setup. Here are the requirements for this\nsetup:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"The instances need to be connected to the same Redis server."}),"\n",(0,i.jsxs)(n.li,{children:["You need to set ",(0,i.jsx)(n.code,{children:"COMPANION_SECRET"})," to the same value on both servers."]}),"\n",(0,i.jsxs)(n.li,{children:["if you use the ",(0,i.jsx)(n.code,{children:"companionKeysParams"})," feature (Transloadit), you also need\n",(0,i.jsx)(n.code,{children:"COMPANION_PREAUTH_SECRET"})," to be the same on each instance."]}),"\n",(0,i.jsxs)(n.li,{children:["All other configuration needs to be the same, except if you\u2019re running many\ninstances on the same machine, then ",(0,i.jsx)(n.code,{children:"COMPANION_PORT"})," should be different for\neach instance."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"api",children:"API"}),"\n",(0,i.jsx)(n.h3,{id:"options",children:"Options"}),"\n",(0,i.jsx)(n.admonition,{type:"tip",children:(0,i.jsxs)(n.p,{children:["The headings display the JS and environment variable options (",(0,i.jsx)(n.code,{children:"option"}),"\n",(0,i.jsx)(n.code,{children:"ENV_OPTION"}),"). When integrating Companion into your own server, you pass the\noptions to ",(0,i.jsx)(n.code,{children:"companion.app()"}),". If you are using the standalone version, you\nconfigure Companion using environment variables. Some options only exist as\nenvironment variables or only as a JS option."]})}),"\n",(0,i.jsxs)(n.details,{children:["\n  ",(0,i.jsx)(n.summary,{children:"Default configuration"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"const options = {\n\tserver: {\n\t\tprotocol: 'http',\n\t\tpath: '',\n\t},\n\tproviderOptions: {},\n\ts3: {\n\t\tendpoint: 'https://{service}.{region}.amazonaws.com',\n\t\tconditions: [],\n\t\tuseAccelerateEndpoint: false,\n\t\tgetKey: ({ filename }) => `${crypto.randomUUID()}-${filename}`,\n\t\texpires: 800, // seconds\n\t},\n\tallowLocalUrls: false,\n\tlogClientVersion: true,\n\tperiodicPingUrls: [],\n\tstreamingUpload: true,\n\tclientSocketConnectTimeout: 60000,\n\tmetrics: true,\n};\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.h4,{id:"filepath-companion_datadir",children:[(0,i.jsx)(n.code,{children:"filePath"})," ",(0,i.jsx)(n.code,{children:"COMPANION_DATADIR"})]}),"\n",(0,i.jsx)(n.p,{children:"Full path to the directory to which provider files will be downloaded\ntemporarily."}),"\n",(0,i.jsxs)(n.h4,{id:"secret-companion_secret-companion_secret_file",children:[(0,i.jsx)(n.code,{children:"secret"})," ",(0,i.jsx)(n.code,{children:"COMPANION_SECRET"})," ",(0,i.jsx)(n.code,{children:"COMPANION_SECRET_FILE"})]}),"\n",(0,i.jsx)(n.p,{children:"A secret string which Companion uses to generate authorization tokens. You\nshould generate a long random string for this. For example:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:"const crypto = require('node:crypto');\n\nconst secret = crypto.randomBytes(64).toString('hex');\n"})}),"\n",(0,i.jsx)(n.admonition,{type:"caution",children:(0,i.jsxs)(n.p,{children:["Omitting the ",(0,i.jsx)(n.code,{children:"secret"})," in the standalone version will generate a secret for you,\nusing the above ",(0,i.jsx)(n.code,{children:"crypto"})," string. But when integrating with Express you must\nprovide it yourself. This is an essential security measure."]})}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsx)(n.p,{children:"Using a secret file means passing an absolute path to a file with any extension,\nwhich has only the secret, nothing else."})}),"\n",(0,i.jsxs)(n.h4,{id:"preauthsecret-companion_preauth_secret-companion_preauth_secret_file",children:[(0,i.jsx)(n.code,{children:"preAuthSecret"})," ",(0,i.jsx)(n.code,{children:"COMPANION_PREAUTH_SECRET"})," ",(0,i.jsx)(n.code,{children:"COMPANION_PREAUTH_SECRET_FILE"})]}),"\n",(0,i.jsxs)(n.p,{children:["If you are using the ",(0,i.jsx)(n.a,{href:"/docs/transloadit",children:"Transloadit"})," ",(0,i.jsx)(n.code,{children:"companionKeysParams"}),"\nfeature (Transloadit-hosted Companion using your own custom OAuth credentials),\nset this variable to a strong randomly generated secret. See also\n",(0,i.jsx)(n.code,{children:"COMPANION_SECRET"})," (but do not use the same secret!)"]}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsx)(n.p,{children:"Using a secret file means passing an absolute path to a file with any extension,\nwhich has only the secret, nothing else."})}),"\n",(0,i.jsxs)(n.h4,{id:"uploadurls-companion_upload_urls",children:[(0,i.jsx)(n.code,{children:"uploadUrls"})," ",(0,i.jsx)(n.code,{children:"COMPANION_UPLOAD_URLS"})]}),"\n",(0,i.jsxs)(n.p,{children:["An allowlist (array) of strings (exact URLs) or regular expressions. Companion\nwill only accept uploads to these URLs. This ensures that your Companion\ninstance is only allowed to upload to your trusted servers and prevents\n",(0,i.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Server-side_request_forgery",children:"SSRF"})," attacks."]}),"\n",(0,i.jsx)(n.h4,{id:"companion_port",children:(0,i.jsx)(n.code,{children:"COMPANION_PORT"})}),"\n",(0,i.jsx)(n.p,{children:"The port on which to start the standalone server, defaults to 3020. This is a\nstandalone-only option."}),"\n",(0,i.jsx)(n.h4,{id:"companion_cookie_domain",children:(0,i.jsx)(n.code,{children:"COMPANION_COOKIE_DOMAIN"})}),"\n",(0,i.jsx)(n.p,{children:"Allows you to customize the domain of the cookies created for Express sessions.\nThis is a standalone-only option."}),"\n",(0,i.jsx)(n.h4,{id:"companion_hide_welcome",children:(0,i.jsx)(n.code,{children:"COMPANION_HIDE_WELCOME"})}),"\n",(0,i.jsxs)(n.p,{children:["Setting this to ",(0,i.jsx)(n.code,{children:"true"})," disables the welcome message shown at ",(0,i.jsx)(n.code,{children:"/"}),". This is a\nstandalone-only option."]}),"\n",(0,i.jsxs)(n.h4,{id:"redisurl-companion_redis_url",children:[(0,i.jsx)(n.code,{children:"redisUrl"})," ",(0,i.jsx)(n.code,{children:"COMPANION_REDIS_URL"})]}),"\n",(0,i.jsxs)(n.p,{children:["URL to running Redis server. This can be used to scale Companion horizontally\nusing many instances. See ",(0,i.jsx)(n.a,{href:"#how-to-scale-companion",children:"How to scale Companion"}),"."]}),"\n",(0,i.jsx)(n.h4,{id:"companion_redis_express_session_prefix",children:(0,i.jsx)(n.code,{children:"COMPANION_REDIS_EXPRESS_SESSION_PREFIX"})}),"\n",(0,i.jsxs)(n.p,{children:["Set a custom prefix for redis keys created by\n",(0,i.jsx)(n.a,{href:"https://github.com/tj/connect-redis",children:"connect-redis"}),". Defaults to\n",(0,i.jsx)(n.code,{children:"companion-session:"}),". Sessions are used for storing authentication state and for\nallowing thumbnails to be loaded by the browser via Companion and for OAuth2.\nSee also ",(0,i.jsx)(n.code,{children:"COMPANION_REDIS_PUBSUB_SCOPE"}),"."]}),"\n",(0,i.jsxs)(n.h4,{id:"redisoptions-companion_redis_options",children:[(0,i.jsx)(n.code,{children:"redisOptions"})," ",(0,i.jsx)(n.code,{children:"COMPANION_REDIS_OPTIONS"})]}),"\n",(0,i.jsxs)(n.p,{children:["An object of\n",(0,i.jsxs)(n.a,{href:"https://github.com/redis/ioredis",children:["options supported by the ",(0,i.jsx)(n.code,{children:"ioredis"})," client"]}),".\nSee also\n",(0,i.jsx)(n.a,{href:"https://github.com/redis/ioredis/blob/af832752040e616daf51621681bcb40cab965a9b/lib/redis/RedisOptions.ts#L8",children:(0,i.jsx)(n.code,{children:"RedisOptions"})}),"."]}),"\n",(0,i.jsxs)(n.h4,{id:"redispubsubscope-companion_redis_pubsub_scope",children:[(0,i.jsx)(n.code,{children:"redisPubSubScope"})," ",(0,i.jsx)(n.code,{children:"COMPANION_REDIS_PUBSUB_SCOPE"})]}),"\n",(0,i.jsxs)(n.p,{children:["Use a scope for the companion events at the Redis server. Setting this option\nwill prefix all events with the name provided and a colon. See also\n",(0,i.jsx)(n.code,{children:"COMPANION_REDIS_EXPRESS_SESSION_PREFIX"}),"."]}),"\n",(0,i.jsx)(n.h4,{id:"server",children:(0,i.jsx)(n.code,{children:"server"})}),"\n",(0,i.jsx)(n.p,{children:"Configuration options for the underlying server."}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Key / Environment variable"}),(0,i.jsx)(n.th,{children:"Value"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"protocol"})," ",(0,i.jsx)(n.code,{children:"COMPANION_PROTOCOL"})]}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"http"})," or ",(0,i.jsx)(n.code,{children:"https"})]}),(0,i.jsxs)(n.td,{children:["Used to build a URL to reference the Companion instance itself, which is used for headers and cookies. Companion itself always runs as a HTTP server, so locally you should use ",(0,i.jsx)(n.code,{children:"http"}),". You must to set this to ",(0,i.jsx)(n.code,{children:"https"})," once you enabled SSL/HTTPS for your domain in production by running a reverse https-proxy in front of Companion, or with a built-in HTTPS feature of your hosting service."]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"host"})," ",(0,i.jsx)(n.code,{children:"COMPANION_DOMAIN"})]}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"String"})}),(0,i.jsxs)(n.td,{children:["Your server\u2019s publicly facing hostname (for example ",(0,i.jsx)(n.code,{children:"example.com"}),")."]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"oauthDomain"})," ",(0,i.jsx)(n.code,{children:"COMPANION_OAUTH_DOMAIN"})]}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"String"})}),(0,i.jsxs)(n.td,{children:["If you have several instances of Companion with different (and perhaps dynamic) subdomains, you can set a single fixed subdomain and server (such as ",(0,i.jsx)(n.code,{children:"sub1.example.com"}),") to handle your OAuth authentication for you. This would then redirect back to the correct instance with the required credentials on completion. This way you only need to configure a single callback URL for OAuth providers."]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"path"})," ",(0,i.jsx)(n.code,{children:"COMPANION_PATH"})]}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"String"})}),(0,i.jsxs)(n.td,{children:["The server path to where the Companion app is sitting. For instance, if Companion is at ",(0,i.jsx)(n.code,{children:"example.com/companion"}),", then the path would be ",(0,i.jsx)(n.code,{children:"/companion"}),")."]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"implicitPath"})," ",(0,i.jsx)(n.code,{children:"COMPANION_IMPLICIT_PATH"})]}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"String"})}),(0,i.jsxs)(n.td,{children:["If the URL\u2019s path in your reverse proxy is different from your Companion path in your express app, then you need to set this path as ",(0,i.jsx)(n.code,{children:"implicitPath"}),". For instance, if your Companion URL is ",(0,i.jsx)(n.code,{children:"example.com/mypath/companion"}),". Where the path ",(0,i.jsx)(n.code,{children:"/mypath"})," is defined in your NGINX server, while ",(0,i.jsx)(n.code,{children:"/companion"})," is set in your express app. Then you need to set the option ",(0,i.jsx)(n.code,{children:"implicitPath"})," to ",(0,i.jsx)(n.code,{children:"/mypath"}),", and set the ",(0,i.jsx)(n.code,{children:"path"})," option to ",(0,i.jsx)(n.code,{children:"/companion"}),"."]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"validHosts"})," ",(0,i.jsx)(n.code,{children:"COMPANION_DOMAINS"})]}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"Array"})}),(0,i.jsxs)(n.td,{children:["If you are setting an ",(0,i.jsx)(n.code,{children:"oauthDomain"}),", you need to set a list of valid hosts, so the oauth handler can validate the host of the Uppy instance requesting the authentication. This is essentially a list of valid domains running your Companion instances. The list may also contain regex patterns. e.g ",(0,i.jsx)(n.code,{children:"['sub2.example.com', 'sub3.example.com', '(\\\\w+).example.com']"})]})]})]})]}),"\n",(0,i.jsxs)(n.h4,{id:"sendselfendpoint-companion_self_endpoint",children:[(0,i.jsx)(n.code,{children:"sendSelfEndpoint"})," ",(0,i.jsx)(n.code,{children:"COMPANION_SELF_ENDPOINT"})]}),"\n",(0,i.jsxs)(n.p,{children:["This is essentially the same as the ",(0,i.jsx)(n.code,{children:"server.host + server.path"})," attributes. The\nmajor reason for this attribute is that, when set, it adds the value as the\n",(0,i.jsx)(n.code,{children:"i-am"})," header of every request response."]}),"\n",(0,i.jsx)(n.h4,{id:"provideroptions",children:(0,i.jsx)(n.code,{children:"providerOptions"})}),"\n",(0,i.jsx)(n.p,{children:"Object to enable providers with their keys and secrets. For example:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n\t"drive": {\n\t\t"key": "***",\n\t\t"secret": "***"\n\t}\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["When using the standalone version you use the corresponding environment\nvariables or point to a secret file (such as ",(0,i.jsx)(n.code,{children:"COMPANION_GOOGLE_SECRET_FILE"}),")."]}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsx)(n.p,{children:"Secret files need an absolute path to a file with any extension which only has\nthe secret, nothing else."})}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Service"}),(0,i.jsx)(n.th,{children:"Key"}),(0,i.jsx)(n.th,{children:"Environment variables"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Box"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"box"})}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"COMPANION_BOX_KEY"}),", ",(0,i.jsx)(n.code,{children:"COMPANION_BOX_SECRET"}),", ",(0,i.jsx)(n.code,{children:"COMPANION_BOX_SECRET_FILE"})]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Dropbox"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"dropbox"})}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"COMPANION_DROPBOX_KEY"}),", ",(0,i.jsx)(n.code,{children:"COMPANION_DROPBOX_SECRET"}),", ",(0,i.jsx)(n.code,{children:"COMPANION_DROPBOX_SECRET_FILE"})]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Facebook"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"facebook"})}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"COMPANION_FACEBOOK_KEY"}),", ",(0,i.jsx)(n.code,{children:"COMPANION_FACEBOOK_SECRET"}),", ",(0,i.jsx)(n.code,{children:"COMPANION_FACEBOOK_SECRET_FILE"})]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Google Drive"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"drive"})}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"COMPANION_GOOGLE_KEY"}),", ",(0,i.jsx)(n.code,{children:"COMPANION_GOOGLE_SECRET"}),", ",(0,i.jsx)(n.code,{children:"COMPANION_GOOGLE_SECRET_FILE"})]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Google Photos"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"googlephotos"})}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"COMPANION_GOOGLE_KEY"}),", ",(0,i.jsx)(n.code,{children:"COMPANION_GOOGLE_SECRET"}),", ",(0,i.jsx)(n.code,{children:"COMPANION_GOOGLE_SECRET_FILE"})]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Instagram"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"instagram"})}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"COMPANION_INSTAGRAM_KEY"}),", ",(0,i.jsx)(n.code,{children:"COMPANION_INSTAGRAM_SECRET"}),", ",(0,i.jsx)(n.code,{children:"COMPANION_INSTAGRAM_SECRET_FILE"})]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"OneDrive"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"onedrive"})}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"COMPANION_ONEDRIVE_KEY"}),", ",(0,i.jsx)(n.code,{children:"COMPANION_ONEDRIVE_SECRET"}),", ",(0,i.jsx)(n.code,{children:"COMPANION_ONEDRIVE_SECRET_FILE"}),", ",(0,i.jsx)(n.code,{children:"COMPANION_ONEDRIVE_DOMAIN_VALIDATION"})," (Settings this variable to ",(0,i.jsx)(n.code,{children:"true"})," enables a route that can be used to validate your app with OneDrive)"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Zoom"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"zoom"})}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"COMPANION_ZOOM_KEY"}),", ",(0,i.jsx)(n.code,{children:"COMPANION_ZOOM_SECRET"}),", ",(0,i.jsx)(n.code,{children:"COMPANION_ZOOM_SECRET_FILE"}),", ",(0,i.jsx)(n.code,{children:"COMPANION_ZOOM_VERIFICATION_TOKEN"})]})]})]})]}),"\n",(0,i.jsx)(n.h4,{id:"s3",children:(0,i.jsx)(n.code,{children:"s3"})}),"\n",(0,i.jsx)(n.p,{children:"Companion comes with signature endpoints for AWS S3. These can be used by the\nUppy client to sign requests to upload files directly to S3, without exposing\nsecret S3 keys in the browser. Companion also supports uploading files from\nproviders like Dropbox and Instagram directly into S3."}),"\n",(0,i.jsxs)(n.h5,{id:"s3key-companion_aws_key",children:[(0,i.jsx)(n.code,{children:"s3.key"})," ",(0,i.jsx)(n.code,{children:"COMPANION_AWS_KEY"})]}),"\n",(0,i.jsx)(n.p,{children:"The S3 access key ID."}),"\n",(0,i.jsxs)(n.h5,{id:"s3secret-companion_aws_secret-companion_aws_secret_file",children:[(0,i.jsx)(n.code,{children:"s3.secret"})," ",(0,i.jsx)(n.code,{children:"COMPANION_AWS_SECRET"})," ",(0,i.jsx)(n.code,{children:"COMPANION_AWS_SECRET_FILE"})]}),"\n",(0,i.jsx)(n.p,{children:"The S3 secret access key."}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsx)(n.p,{children:"Using a secret file means passing an absolute path to a file with any extension,\nwhich has only the secret, nothing else."})}),"\n",(0,i.jsxs)(n.h5,{id:"s3endpoint-companion_aws_endpoint",children:[(0,i.jsx)(n.code,{children:"s3.endpoint"})," ",(0,i.jsx)(n.code,{children:"COMPANION_AWS_ENDPOINT"})]}),"\n",(0,i.jsx)(n.p,{children:"Optional URL to a custom S3 (compatible) service. Otherwise uses the default\nfrom the AWS SDK."}),"\n",(0,i.jsxs)(n.h5,{id:"s3bucket-companion_aws_bucket",children:[(0,i.jsx)(n.code,{children:"s3.bucket"})," ",(0,i.jsx)(n.code,{children:"COMPANION_AWS_BUCKET"})]}),"\n",(0,i.jsx)(n.p,{children:"The name of the bucket to store uploaded files in."}),"\n",(0,i.jsxs)(n.p,{children:["A ",(0,i.jsx)(n.code,{children:"string"})," or function that returns the name of the bucket as a ",(0,i.jsx)(n.code,{children:"string"})," and\ntakes one argument which is an object with the following properties:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"filename"}),", the original name of the uploaded file;"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"metadata"})," provided by the user for the file (will only be provided during the\ninitial calls for each uploaded files, otherwise it will be ",(0,i.jsx)(n.code,{children:"undefined"}),")."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"req"}),", Express.js ",(0,i.jsx)(n.code,{children:"Request"})," object. Do not use any Companion internals from\nthe req object, as these might change in any minor version of Companion."]}),"\n"]}),"\n",(0,i.jsxs)(n.h4,{id:"s3forcepathstyle-companion_aws_force_path_style",children:[(0,i.jsx)(n.code,{children:"s3.forcePathStyle"})," ",(0,i.jsx)(n.code,{children:"COMPANION_AWS_FORCE_PATH_STYLE"})]}),"\n",(0,i.jsxs)(n.p,{children:["This adds support for setting the S3 client\u2019s ",(0,i.jsx)(n.code,{children:"forcePathStyle"})," option. That is\nnecessary to use Uppy/Companion alongside localstack in development\nenvironments. ",(0,i.jsx)(n.strong,{children:"Default"}),": ",(0,i.jsx)(n.code,{children:"false"}),"."]}),"\n",(0,i.jsxs)(n.h5,{id:"s3region-companion_aws_region",children:[(0,i.jsx)(n.code,{children:"s3.region"})," ",(0,i.jsx)(n.code,{children:"COMPANION_AWS_REGION"})]}),"\n",(0,i.jsx)(n.p,{children:"The datacenter region where the target bucket is located."}),"\n",(0,i.jsx)(n.h5,{id:"companion_aws_prefix",children:(0,i.jsx)(n.code,{children:"COMPANION_AWS_PREFIX"})}),"\n",(0,i.jsxs)(n.p,{children:["An optional prefix for all uploaded keys. This is a standalone-only option. The\nsame can be achieved by the ",(0,i.jsx)(n.code,{children:"getKey"})," option when using the express middleware."]}),"\n",(0,i.jsx)(n.h5,{id:"s3awsclientoptions",children:(0,i.jsx)(n.code,{children:"s3.awsClientOptions"})}),"\n",(0,i.jsxs)(n.p,{children:["You can supply any\n",(0,i.jsx)(n.a,{href:"https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/S3.html#constructor-property",children:"S3 option supported by the AWS SDK"}),"\nin the ",(0,i.jsx)(n.code,{children:"providerOptions.s3.awsClientOptions"})," object, ",(0,i.jsx)(n.em,{children:"except for"})," the below:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"accessKeyId"}),". Instead, use the ",(0,i.jsx)(n.code,{children:"providerOptions.s3.key"})," property. This is to\nmake configuration names consistent between different Companion features."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"secretAccessKey"}),". Instead, use the ",(0,i.jsx)(n.code,{children:"providerOptions.s3.secret"})," property. This\nis to make configuration names consistent between different Companion\nfeatures."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Be aware that some options may cause wrong behaviour if they conflict with\nCompanion\u2019s assumptions. If you find that a particular option does not work as\nexpected, please\n",(0,i.jsx)(n.a,{href:"https://github.com/transloadit/uppy/issues/new",children:"open an issue on the Uppy repository"}),"\nso we can document it here."]}),"\n",(0,i.jsx)(n.h5,{id:"s3getkey-filename-metadata-req-",children:(0,i.jsx)(n.code,{children:"s3.getKey({ filename, metadata, req })"})}),"\n",(0,i.jsx)(n.p,{children:"Get the key name for a file. The key is the file path to which the file will be\nuploaded in your bucket. This option should be a function receiving three\narguments:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"filename"}),", the original name of the uploaded file;"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"metadata"}),", user-provided metadata for the file."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"req"}),", Express.js ",(0,i.jsx)(n.code,{children:"Request"})," object. Do not use any Companion internals from\nthe req object, as these might change in any minor version of Companion."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["This function should return a string ",(0,i.jsx)(n.code,{children:"key"}),". The ",(0,i.jsx)(n.code,{children:"req"})," parameter can be used to\nupload to a user-specific folder in your bucket, for example:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:"app.use(authenticationMiddleware);\napp.use(\n\tuppy.app({\n\t\tproviderOptions: {\n\t\t\ts3: {\n\t\t\t\tgetKey: ({ req, filename, metadata }) => `${req.user.id}/${filename}`,\n\t\t\t\t/* auth options */\n\t\t\t},\n\t\t},\n\t}),\n);\n"})}),"\n",(0,i.jsxs)(n.p,{children:["The default implementation returns the ",(0,i.jsx)(n.code,{children:"filename"}),", so all files will be uploaded\nto the root of the bucket as their original file name."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:"app.use(\n\tuppy.app({\n\t\tproviderOptions: {\n\t\t\ts3: {\n\t\t\t\tgetKey: ({ filename, metadata }) => filename,\n\t\t\t},\n\t\t},\n\t}),\n);\n"})}),"\n",(0,i.jsx)(n.p,{children:"When signing on the client, this function will only be called for multipart\nuploads."}),"\n",(0,i.jsx)(n.h4,{id:"companion_aws_use_accelerate_endpoint",children:(0,i.jsx)(n.code,{children:"COMPANION_AWS_USE_ACCELERATE_ENDPOINT"})}),"\n",(0,i.jsxs)(n.p,{children:["Enable S3\n",(0,i.jsx)(n.a,{href:"https://docs.aws.amazon.com/AmazonS3/latest/userguide/transfer-acceleration.html",children:"Transfer Acceleration"}),".\nThis is a standalone-only option."]}),"\n",(0,i.jsx)(n.h4,{id:"companion_aws_expires",children:(0,i.jsx)(n.code,{children:"COMPANION_AWS_EXPIRES"})}),"\n",(0,i.jsxs)(n.p,{children:["Set ",(0,i.jsx)(n.code,{children:"X-Amz-Expires"})," query parameter in the presigned urls (in seconds, default:\n300). This is a standalone-only option."]}),"\n",(0,i.jsx)(n.h4,{id:"companion_aws_acl",children:(0,i.jsx)(n.code,{children:"COMPANION_AWS_ACL"})}),"\n",(0,i.jsxs)(n.p,{children:["Set a\n",(0,i.jsx)(n.a,{href:"https://docs.aws.amazon.com/AmazonS3/latest/dev/acl-overview.html#canned-acl",children:"Canned ACL"}),"\nfor uploaded objects. This is a standalone-only option."]}),"\n",(0,i.jsx)(n.h4,{id:"customproviders",children:(0,i.jsx)(n.code,{children:"customProviders"})}),"\n",(0,i.jsxs)(n.p,{children:["This option enables you to add custom providers along with the already supported\nproviders. See ",(0,i.jsx)(n.a,{href:"#how-to-add-custom-providers",children:"adding custom providers"})," for more\ninformation."]}),"\n",(0,i.jsx)(n.h4,{id:"logclientversion",children:(0,i.jsx)(n.code,{children:"logClientVersion"})}),"\n",(0,i.jsx)(n.p,{children:"A boolean flag to tell Companion whether to log its version upon startup."}),"\n",(0,i.jsxs)(n.h4,{id:"metrics-companion_hide_metrics",children:[(0,i.jsx)(n.code,{children:"metrics"})," ",(0,i.jsx)(n.code,{children:"COMPANION_HIDE_METRICS"})]}),"\n",(0,i.jsxs)(n.p,{children:["A boolean flag to tell Companion whether to provide an endpoint ",(0,i.jsx)(n.code,{children:"/metrics"})," with\nPrometheus metrics (by default metrics are enabled.)"]}),"\n",(0,i.jsxs)(n.h4,{id:"streamingupload-companion_streaming_upload",children:[(0,i.jsx)(n.code,{children:"streamingUpload"})," ",(0,i.jsx)(n.code,{children:"COMPANION_STREAMING_UPLOAD"})]}),"\n",(0,i.jsxs)(n.p,{children:["A boolean flag to tell Companion whether to enable streaming uploads. If\nenabled, it will lead to ",(0,i.jsx)(n.em,{children:"faster uploads"})," because companion will start uploading\nat the same time as downloading using ",(0,i.jsx)(n.code,{children:"stream.pipe"}),". If ",(0,i.jsx)(n.code,{children:"false"}),", files will be\nfully downloaded first, then uploaded. Defaults to ",(0,i.jsx)(n.code,{children:"true"}),"."]}),"\n",(0,i.jsxs)(n.h4,{id:"maxfilesize-companion_max_file_size",children:[(0,i.jsx)(n.code,{children:"maxFileSize"})," ",(0,i.jsx)(n.code,{children:"COMPANION_MAX_FILE_SIZE"})]}),"\n",(0,i.jsx)(n.p,{children:"If this value is set, companion will limit the maximum file size to process. If\nunset, it will process files without any size limit (this is the default)."}),"\n",(0,i.jsxs)(n.h4,{id:"periodicpingurls-companion_periodic_ping_urls",children:[(0,i.jsx)(n.code,{children:"periodicPingUrls"})," ",(0,i.jsx)(n.code,{children:"COMPANION_PERIODIC_PING_URLS"})]}),"\n",(0,i.jsx)(n.p,{children:"If this value is set, companion will periodically send POST requests to the\nspecified URLs. Useful for keeping track of companion instances as a keep-alive."}),"\n",(0,i.jsxs)(n.h4,{id:"periodicpinginterval-companion_periodic_ping_interval",children:[(0,i.jsx)(n.code,{children:"periodicPingInterval"})," ",(0,i.jsx)(n.code,{children:"COMPANION_PERIODIC_PING_INTERVAL"})]}),"\n",(0,i.jsx)(n.p,{children:"Interval for periodic ping requests (in ms)."}),"\n",(0,i.jsxs)(n.h4,{id:"periodicpingstaticpayload-companion_periodic_ping_static_json_payload",children:[(0,i.jsx)(n.code,{children:"periodicPingStaticPayload"})," ",(0,i.jsx)(n.code,{children:"COMPANION_PERIODIC_PING_STATIC_JSON_PAYLOAD"})]}),"\n",(0,i.jsxs)(n.p,{children:["A ",(0,i.jsx)(n.code,{children:"JSON.stringify"}),"-able JavaScript Object that will be sent as part of the JSON\nbody in the period ping requests."]}),"\n",(0,i.jsxs)(n.h4,{id:"allowlocalurls-companion_allow_local_urls",children:[(0,i.jsx)(n.code,{children:"allowLocalUrls"})," ",(0,i.jsx)(n.code,{children:"COMPANION_ALLOW_LOCAL_URLS"})]}),"\n",(0,i.jsx)(n.p,{children:"A boolean flag to tell Companion whether to allow requesting local URLs\n(non-internet IPs)."}),"\n",(0,i.jsx)(n.admonition,{type:"caution",children:(0,i.jsxs)(n.p,{children:["Only enable this in development. ",(0,i.jsx)(n.strong,{children:"Enabling it in production is a security\nrisk."})]})}),"\n",(0,i.jsxs)(n.h4,{id:"corsorigins-required",children:[(0,i.jsx)(n.code,{children:"corsOrigins"})," (required)"]}),"\n",(0,i.jsxs)(n.p,{children:["Allowed CORS Origins. Passed as the ",(0,i.jsx)(n.code,{children:"origin"})," option in\n",(0,i.jsx)(n.a,{href:"https://github.com/expressjs/cors#configuration-options",children:"cors"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["Note this is used for both CORS\u2019 ",(0,i.jsx)(n.code,{children:"Access-Control-Allow-Origin"})," header, and for\nthe\n",(0,i.jsx)(n.a,{href:"https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage#targetorigin",children:(0,i.jsx)(n.code,{children:"targetOrigin"})}),"\nfor ",(0,i.jsx)(n.code,{children:"postMessage"})," calls in the context of OAuth."]}),"\n",(0,i.jsxs)(n.p,{children:["Setting it to ",(0,i.jsx)(n.code,{children:"true"})," treats any origin as a trusted one, making it easier to\nimpersonate your brand. Setting it to ",(0,i.jsx)(n.code,{children:"false"})," disables cross-origin support, use\nthis if you\u2019re serving Companion and Uppy from the same domain name."]}),"\n",(0,i.jsx)(n.h5,{id:"companion_client_origins",children:(0,i.jsx)(n.code,{children:"COMPANION_CLIENT_ORIGINS"})}),"\n",(0,i.jsxs)(n.p,{children:["Stand-alone alternative to the ",(0,i.jsx)(n.code,{children:"corsOrigins"})," option. A comma-separated string of\norigins, or ",(0,i.jsx)(n.code,{children:"'true'"})," (which will be interpreted as the boolean value ",(0,i.jsx)(n.code,{children:"true"}),"), or\n",(0,i.jsx)(n.code,{children:"'false'"})," (which will be interpreted as the boolean value ",(0,i.jsx)(n.code,{children:"false"}),").\n",(0,i.jsx)(n.code,{children:"COMPANION_CLIENT_ORIGINS_REGEX"})," will be ignored if this option is used."]}),"\n",(0,i.jsx)(n.h5,{id:"companion_client_origins_regex",children:(0,i.jsx)(n.code,{children:"COMPANION_CLIENT_ORIGINS_REGEX"})}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsxs)(n.p,{children:["In most cases, you should not be using a regex, and instead provide the list of\naccepted origins to ",(0,i.jsx)(n.code,{children:"COMPANION_CLIENT_ORIGINS"}),". If you have to use this option,\nhave in mind that this regex will be used to parse unfiltered user input, so\nmake sure you\u2019re validating the entirety of the string."]})}),"\n",(0,i.jsxs)(n.p,{children:["Stand-alone alternative to the ",(0,i.jsx)(n.code,{children:"corsOrigins"})," option. Like\n",(0,i.jsx)(n.code,{children:"COMPANION_CLIENT_ORIGINS"}),", but allows a single regex instead."]}),"\n",(0,i.jsxs)(n.h4,{id:"chunksize-companion_chunk_size",children:[(0,i.jsx)(n.code,{children:"chunkSize"})," ",(0,i.jsx)(n.code,{children:"COMPANION_CHUNK_SIZE"})]}),"\n",(0,i.jsxs)(n.p,{children:["Controls how big the uploaded chunks are for AWS S3 Multipart and Tus. Smaller\nvalues lead to more overhead, but larger values lead to slower retries in case\nof bad network connections. Passed to tus-js-client\n",(0,i.jsx)(n.a,{href:"https://github.com/tus/tus-js-client/blob/master/docs/api.md#chunksize",children:(0,i.jsx)(n.code,{children:"chunkSize"})}),"\nas well as\n",(0,i.jsx)(n.a,{href:"https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/S3.html",children:"AWS S3 Multipart"}),"\n",(0,i.jsx)(n.code,{children:"partSize"}),"."]}),"\n",(0,i.jsxs)(n.h4,{id:"enableurlendpoint-companion_enable_url_endpoint",children:[(0,i.jsx)(n.code,{children:"enableUrlEndpoint"})," ",(0,i.jsx)(n.code,{children:"COMPANION_ENABLE_URL_ENDPOINT"})]}),"\n",(0,i.jsxs)(n.p,{children:["Set this to ",(0,i.jsx)(n.code,{children:"true"})," to enable the ",(0,i.jsx)(n.a,{href:"https://uppy.io/docs/url/",children:"URL functionalily"}),".\nDefault: ",(0,i.jsx)(n.code,{children:"false"}),"."]}),"\n",(0,i.jsxs)(n.h4,{id:"enablegooglepickerendpoint-companion_enable_google_picker_endpoint",children:[(0,i.jsx)(n.code,{children:"enableGooglePickerEndpoint"})," ",(0,i.jsx)(n.code,{children:"COMPANION_ENABLE_GOOGLE_PICKER_ENDPOINT"})]}),"\n",(0,i.jsxs)(n.p,{children:["Set this to ",(0,i.jsx)(n.code,{children:"true"})," to enable the Google Picker (Photos / Drive) functionality.\nDefault: ",(0,i.jsx)(n.code,{children:"false"}),"."]}),"\n",(0,i.jsx)(n.h3,{id:"events",children:"Events"}),"\n",(0,i.jsxs)(n.p,{children:["The object returned by ",(0,i.jsx)(n.code,{children:"companion.app()"})," also has a property ",(0,i.jsx)(n.code,{children:"companionEmitter"}),"\nwhich is an ",(0,i.jsx)(n.code,{children:"EventEmitter"})," that emits the following events:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"upload-start"})," - When an upload starts, this event is emitted with an object\ncontaining the property ",(0,i.jsx)(n.code,{children:"token"}),", which is a unique ID for the upload."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"token"})," - The event name is the token from ",(0,i.jsx)(n.code,{children:"upload-start"}),". The event has an\nobject with the following properties:\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"action"})," - One of the following strings:\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"success"})," - When the upload succeeds."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"error"})," - When the upload fails with an error."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"payload"})," - the error or success payload."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Example code for using the ",(0,i.jsx)(n.code,{children:"EventEmitter"})," to handle a finished file upload:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:"const companionApp = companion.app(options);\nconst { companionEmitter: emitter } = companionApp;\n\nemitter.on('upload-start', ({ token }) => {\n\tconsole.log('Upload started', token);\n\n\tfunction onUploadEvent({ action, payload }) {\n\t\tif (action === 'success') {\n\t\t\temitter.off(token, onUploadEvent); // avoid listener leak\n\t\t\tconsole.log('Upload finished', token, payload.url);\n\t\t} else if (action === 'error') {\n\t\t\temitter.off(token, onUploadEvent); // avoid listener leak\n\t\t\tconsole.error('Upload failed', payload);\n\t\t}\n\t}\n\temitter.on(token, onUploadEvent);\n});\n"})}),"\n",(0,i.jsx)(n.h2,{id:"frequently-asked-questions",children:"Frequently asked questions"}),"\n",(0,i.jsx)(n.h3,{id:"do-you-have-a-live-example",children:"Do you have a live example?"}),"\n",(0,i.jsxs)(n.p,{children:["An example server is running at ",(0,i.jsx)(n.a,{href:"https://companion.uppy.io",children:"https://companion.uppy.io"}),"."]}),"\n",(0,i.jsx)(n.h3,{id:"how-does-the-authentication-and-token-mechanism-work",children:"How does the Authentication and Token mechanism work?"}),"\n",(0,i.jsx)(n.p,{children:"This section describes how Authentication works between Companion and Providers.\nWhile this behaviour is the same for all Providers (Dropbox, Instagram, Google\nDrive, etc.), we are going to be referring to Dropbox in place of any Provider\nthroughout this section."}),"\n",(0,i.jsx)(n.p,{children:"The following steps describe the actions that take place when a user\nAuthenticates and Uploads from Dropbox through Companion:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["The visitor to a website with Uppy clicks ",(0,i.jsx)(n.code,{children:"Connect to Dropbox"}),"."]}),"\n",(0,i.jsx)(n.li,{children:"Uppy sends a request to Companion, which in turn sends an OAuth request to\nDropbox (Requires that OAuth credentials from Dropbox have been added to\nCompanion)."}),"\n",(0,i.jsx)(n.li,{children:"Dropbox asks the visitor to log in, and whether the Website should be allowed\nto access your files"}),"\n",(0,i.jsx)(n.li,{children:"If the visitor agrees, Companion will receive a token from Dropbox, with which\nwe can temporarily download files."}),"\n",(0,i.jsx)(n.li,{children:"Companion encrypts the token with a secret key and sends the encrypted token\nto Uppy (client)"}),"\n",(0,i.jsx)(n.li,{children:"Every time the visitor clicks on a folder in Uppy, it asks Companion for the\nnew list of files, with this question, the token (still encrypted by\nCompanion) is sent along."}),"\n",(0,i.jsx)(n.li,{children:"Companion decrypts the token, requests the list of files from Dropbox and\nsends it to Uppy."}),"\n",(0,i.jsx)(n.li,{children:"When a file is selected for upload, Companion receives the token again\naccording to this procedure, decrypts it again, and thereby downloads the file\nfrom Dropbox."}),"\n",(0,i.jsx)(n.li,{children:"As the bytes arrive, Companion uploads the bytes to the final destination\n(depending on the configuration: Apache, a Tus server, S3 bucket, etc)."}),"\n",(0,i.jsx)(n.li,{children:"Companion reports progress to Uppy, as if it were a local upload."}),"\n",(0,i.jsx)(n.li,{children:"Completed!"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"how-to-use-provider-redirect-uris",children:"How to use provider redirect URIs?"}),"\n",(0,i.jsxs)(n.p,{children:["When generating your provider API keys on their corresponding developer\nplatforms (e.g\n",(0,i.jsx)(n.a,{href:"https://console.developers.google.com/",children:"Google Developer Console"}),"), you\u2019d need\nto provide a ",(0,i.jsx)(n.code,{children:"redirect URI"})," for the OAuth authorization process. In general the\nredirect URI for each provider takes the format:"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"http(s)://$YOUR_COMPANION_HOST_NAME/$PROVIDER_NAME/redirect"})}),"\n",(0,i.jsxs)(n.p,{children:["For example, if your Companion server is hosted on\n",(0,i.jsx)(n.code,{children:"https://my.companion.server.com"}),", then the redirect URI you would supply for\nyour OneDrive provider would be:"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"https://my.companion.server.com/onedrive/redirect"})}),"\n",(0,i.jsxs)(n.p,{children:["Please see\n",(0,i.jsx)(n.a,{href:"https://uppy.io/docs/companion/#Supported-providers",children:"Supported Providers"})," for a\nlist of all Providers and their corresponding names."]}),"\n",(0,i.jsx)(n.h3,{id:"how-to-use-companion-with-kubernetes",children:"How to use Companion with Kubernetes?"}),"\n",(0,i.jsxs)(n.p,{children:["We have a detailed\n",(0,i.jsx)(n.a,{href:"https://github.com/transloadit/uppy/blob/main/packages/%40uppy/companion/KUBERNETES.md",children:"guide"}),"\non running Companion in Kubernetes."]}),"\n",(0,i.jsx)(n.h3,{id:"how-to-add-custom-providers",children:"How to add custom providers?"}),"\n",(0,i.jsxs)(n.p,{children:["As of now, Companion supports the\n",(0,i.jsx)(n.a,{href:"https://uppy.io/docs/companion/#Supported-providers",children:"providers listed here"})," out\nof the box, but you may also choose to add your own custom providers. You can do\nthis by passing the ",(0,i.jsx)(n.code,{children:"customProviders"})," option when calling the Uppy ",(0,i.jsx)(n.code,{children:"app"})," method.\nThe custom provider is expected to support Oauth 1 or 2 for\nauthentication/authorization."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"import providerModule from './path/to/provider/module';\n\nconst options = {\n\tcustomProviders: {\n\t\tmyprovidername: {\n\t\t\tconfig: {\n\t\t\t\tauthorize_url: 'https://mywebsite.com/authorize',\n\t\t\t\taccess_url: 'https://mywebsite.com/token',\n\t\t\t\toauth: 2,\n\t\t\t\tkey: '***',\n\t\t\t\tsecret: '***',\n\t\t\t\tscope: ['read', 'write'],\n\t\t\t},\n\t\t\tmodule: providerModule,\n\t\t},\n\t},\n};\n\nuppy.app(options);\n"})}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"customProviders"})," option should be an object containing each custom\nprovider. Each custom provider would, in turn, be an object with two keys,\n",(0,i.jsx)(n.code,{children:"config"})," and ",(0,i.jsx)(n.code,{children:"module"}),". The ",(0,i.jsx)(n.code,{children:"config"})," option would contain Oauth API settings,\nwhile the ",(0,i.jsx)(n.code,{children:"module"})," would point to the provider module."]}),"\n",(0,i.jsxs)(n.p,{children:["To work well with Companion, the ",(0,i.jsx)(n.strong,{children:"module"})," must be a class with the following\nmethods. Note that the methods must be ",(0,i.jsx)(n.code,{children:"async"}),", return a ",(0,i.jsx)(n.code,{children:"Promise"})," or reject\nwith an ",(0,i.jsx)(n.code,{children:"Error"}),"):"]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"async list ({ token, directory, query })"})," - Returns a object containing a\nlist of user files (such as a list of all the files in a particular\ndirectory). See ",(0,i.jsx)(n.a,{href:"#list-data",children:"example returned list data structure"}),". ",(0,i.jsx)(n.code,{children:"token"})," -\nauthorization token (retrieved from oauth process) to send along with your\nrequest\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"directory"})," - the id/name of the directory from which data is to be\nretrieved. This may be ignored if it doesn\u2019t apply to your provider"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"query"})," - expressjs query params object received by the server (in case\nsome data you need in there)."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"async download ({ token, id, query })"})," - Downloads a particular file from\nthe provider. Returns an object with a single property ",(0,i.jsx)(n.code,{children:"{ stream }"})," - a\n",(0,i.jsx)(n.a,{href:"https://nodejs.org/api/stream.html#stream_class_stream_readable",children:(0,i.jsx)(n.code,{children:"stream.Readable"})}),",\nwhich will be read from and uploaded to the destination. To prevent memory\nleaks, make sure you release your stream if you reject this method with an\nerror.\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"token"})," - authorization token (retrieved from oauth process) to send along\nwith your request."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"id"})," - ID of the file being downloaded."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"query"})," - expressjs query params object received by the server (in case\nsome data you need in there)."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"async size ({ token, id, query })"})," - Returns the byte size of the file that\nneeds to be downloaded as a ",(0,i.jsx)(n.code,{children:"Number"}),". If the size of the object is not known,\n",(0,i.jsx)(n.code,{children:"null"})," may be returned.\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"token"})," - authorization token (retrieved from oauth process) to send along\nwith your request."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"id"})," - ID of the file being downloaded."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"query"})," - expressjs query params object received by the server (in case\nsome data you need in there)."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"The class must also have:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["A unique ",(0,i.jsx)(n.code,{children:"static authProvider"})," string property - a lowercased value which\nindicates name of the ",(0,i.jsx)(n.a,{href:"https://github.com/simov/grant",children:(0,i.jsx)(n.code,{children:"grant"})})," OAuth2\nprovider to use (e.g ",(0,i.jsx)(n.code,{children:"google"})," for Google). If your provider doesn\u2019t use\nOAuth2, you can omit this property."]}),"\n",(0,i.jsxs)(n.li,{children:["A ",(0,i.jsx)(n.code,{children:"static"})," property ",(0,i.jsx)(n.code,{children:"static version = 2"}),", which is the current version of the\nCompanion Provider API."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["See also\n",(0,i.jsx)(n.a,{href:"https://github.com/transloadit/uppy/blob/main/examples/custom-provider/server",children:"example code with a custom provider"}),"."]}),"\n",(0,i.jsx)(n.h4,{id:"list-data",children:"list data"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n\t// username or email of the user whose provider account is being accessed\n\t"username": "johndoe",\n\t// list of files and folders in the directory. An item is considered a folder\n\t//  if it mainly exists as a collection to contain sub-items\n\t"items": [\n\t\t{\n\t\t\t// boolean value of whether or NOT it\'s a folder\n\t\t\t"isFolder": false,\n\t\t\t// icon image URL\n\t\t\t"icon": "https://random-api.url.com/fileicon.jpg",\n\t\t\t// name of the item\n\t\t\t"name": "myfile.jpg",\n\t\t\t// the mime type of the item. Only relevant if the item is NOT a folder\n\t\t\t"mimeType": "image/jpg",\n\t\t\t// the id (in string) of the item\n\t\t\t"id": "uniqueitemid",\n\t\t\t// thumbnail image URL. Only relevant if the item is NOT a folder\n\t\t\t"thumbnail": "https://random-api.url.com/filethumbnail.jpg",\n\t\t\t// for folders this is typically the value that will be passed as "directory" in the list(...) method.\n\t\t\t// For files, this is the value that will be passed as id in the download(...) method.\n\t\t\t"requestPath": "file-or-folder-requestpath",\n\t\t\t// datetime string (in ISO 8601 format) of when this item was last modified\n\t\t\t"modifiedDate": "2020-06-29T19:59:58Z",\n\t\t\t// the size in bytes of the item. Only relevant if the item is NOT a folder\n\t\t\t"size": 278940,\n\t\t\t"custom": {\n\t\t\t\t// an object that may contain some more custom fields that you may need to send to the client. Only add this object if you have a need for it.\n\t\t\t\t"customData1": "the value",\n\t\t\t\t"customData2": "the value"\n\t\t\t}\n\t\t\t// more items here\n\t\t}\n\t],\n\t// if the "items" list is paginated, this is the request path needed to fetch the next page.\n\t"nextPagePath": "directory-name?cursor=cursor-to-next-page"\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"how-to-run-companion-locally",children:"How to run Companion locally?"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"To set up Companion for local development, please clone the Uppy repo and\ninstall, like so:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"git clone https://github.com/transloadit/uppy\ncd uppy\nyarn install\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Configure your environment variables by copying the ",(0,i.jsx)(n.code,{children:"env.example.sh"})," file to\n",(0,i.jsx)(n.code,{children:"env.sh"})," and edit it to its correct values."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"cp .env.example .env\n$EDITOR .env\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"To start the server, run:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"yarn run start:companion\n"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["This would get the Companion instance running on ",(0,i.jsx)(n.code,{children:"http://localhost:3020"}),". It\nuses ",(0,i.jsx)(n.a,{href:"https://nodejs.org/api/cli.html#--watch",children:(0,i.jsx)(n.code,{children:"node --watch"})})," so it will\nautomatically restart when files are changed."]})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},28453:(e,n,o)=>{o.d(n,{R:()=>r,x:()=>d});var i=o(96540);const s={},t=i.createContext(s);function r(e){const n=i.useContext(t);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);